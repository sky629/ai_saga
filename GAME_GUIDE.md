# AI Saga — 게임 가이드

AI Saga는 텍스트 기반 로그라이크 MUD(Multi-User Dungeon) 게임입니다. 플레이어는 시나리오를 선택하고 캐릭터를 생성한 뒤, AI 게임 마스터와 함께 턴 기반 어드벤처를 펼칩니다. 게임을 플레이할수록 유저의 레벨이 상승하여 더 강한 캐릭터로 다음 게임을 시작할 수 있는 메타 프로그레션 시스템을 갖추고 있습니다.

---

## 목차

1. [게임 개요](#1-게임-개요)
2. [플레이 방식 및 전체 플로우](#2-플레이-방식-및-전체-플로우)
3. [주사위 판정 시스템](#3-주사위-판정-시스템)
4. [일러스트 생성 시스템](#4-일러스트-생성-시스템)
5. [메타 프로그레션 시스템](#5-메타-프로그레션-시스템)
6. [게임 엔딩 시스템](#6-게임-엔딩-시스템)
7. [수치 요약표](#7-수치-요약표)

---

## 1. 게임 개요

| 항목 | 내용 |
|------|------|
| **장르** | 텍스트 기반 로그라이크 MUD |
| **시점** | 2인칭 (당신은...) |
| **언어** | 한국어 |
| **턴 구조** | 최대 30턴 (시나리오별 설정 가능) |
| **엔딩 유형** | 승리(Victory) / 패배(Defeat) / 중립(Neutral) |

### 게임 흐름 한 눈에 보기

```
시나리오 선택 → 캐릭터 생성 → 게임 시작 → 턴 반복 → 엔딩 생성 → XP 획득 → 유저 레벨업
                     ↑ 유저 레벨이 높을수록 강한 캐릭터로 시작 (메타 프로그레션)
```

---

## 2. 플레이 방식 및 전체 플로우

### 2-1. 게임 시작 (StartGame)

1. **시나리오 선택**: 플레이 가능한 시나리오 목록에서 선택
2. **캐릭터 생성**: 이름과 설명을 입력하면 캐릭터가 생성됩니다
   - 유저의 현재 게임 레벨을 캐릭터 레벨로 상속
   - 시작 HP = `100 + (유저레벨 - 1) × 10`
3. **초기 내러티브 생성**: AI 게임 마스터가 시나리오 배경과 현재 상황을 묘사
4. **세션 상태**: `ACTIVE`로 설정, `turn_count = 0`에서 시작

### 2-2. 턴 진행 (ProcessAction)

매 턴은 다음 순서로 진행됩니다:

```
플레이어 입력
    │
    ▼
①  중복 요청 검사 (idempotency key 캐시, TTL 600s)
    │
    ▼
②  세션 유효성 검사
    │  - 세션이 ACTIVE 상태인지 확인
    │  - 남은 턴이 있는지 확인
    │
    ▼
③  turn_count += 1
    │
    ▼
④  플레이어 메시지 임베딩 생성 → DB 저장 (pgvector 768-dim)
    │
    ▼
⑤  컨텍스트 구성 (하이브리드: 슬라이딩 윈도우 + RAG)
    │  - 최근 10개 메시지 (슬라이딩 윈도우)
    │  - 유사도 상위 5개 메시지 (pgvector 코사인 거리 ≤ 0.3)
    │
    ▼
⑥  마지막 턴인가?
    ├─ Yes → ⑦A 엔딩 처리
    └─ No  → ⑦B 일반 턴 처리
```

#### ⑦A 마지막 턴 — 엔딩 처리

→ [게임 엔딩 시스템 참고](#5-게임-엔딩-시스템)

#### ⑦B 일반 턴 — 정상 처리

```
주사위 판정 실행 (DiceService)
    │
    ▼
LLM 호출 (GameMaster 프롬프트)
    │  JSON 응답 파싱:
    │  {
    │    "before_narrative": "행동 시도 직전 상황 묘사 (주사위 있을 때만)",
    │    "narrative":        "주사위 결과를 반영한 최종 서술",
    │    "options":          ["선택지1", "선택지2", "선택지3"],
    │    "dice_applied":     true/false,
    │    "state_changes": {
    │      "hp_change":         0,
    │      "items_gained":      [],
    │      "items_lost":        [],
    │      "location":          "이동한 장소 (변경 시만)",
    │      "npcs_met":          [],
    │      "discoveries":       []
    │    }
    │  }
    │
    ▼
주사위 실패 시 state_changes 필터링
    │  - 제거: location, items_gained
    │  - 유지: hp_change, items_lost, npcs_met, discoveries
    │
    ▼
캐릭터 상태 업데이트
    │  - HP 변경, 인벤토리 변경, 위치 변경
    │
    ▼
캐릭터 사망 여부 확인 (HP ≤ 0)
    ├─ Yes → 즉시 패배 엔딩 처리
    └─ No  → 계속
    │
    ▼
AI 응답 임베딩 생성 → DB 저장
    │
    ▼
GameActionResponse 반환
```

### 2-3. 세션 상태 머신

```
  ACTIVE ──────────────────────────────────────────────► COMPLETED
    │   (max_turns 도달 또는 HP=0 → 엔딩 생성)
    │
    ▼
  PAUSED ◄────► ACTIVE
       (pause / resume)
```

| 상태 | 설명 |
|------|------|
| `ACTIVE` | 게임 진행 중 |
| `PAUSED` | 일시 정지 |
| `COMPLETED` | 게임 종료 (엔딩 유형 확정) |

---

## 3. 주사위 판정 시스템

AI Saga는 **D&D 5e** 기반의 d20 판정 시스템을 사용합니다.

### 3-1. 기본 판정 흐름

```
1d20 (랜덤 1~20)
    + 숙련 보너스 (캐릭터 레벨에 따라)
    = 최종 합계 (total)

total ≥ DC(난이도)  →  성공
total < DC(난이도)  →  실패
roll = 20           →  크리티컬 (대성공)
roll = 1            →  펌블 (대실패)
```

### 3-2. 숙련 보너스 (Modifier)

D&D 5e 공식을 따릅니다:

```
보너스 = (레벨 - 1) // 4 + 2
```

| 레벨 | 보너스 |
|------|--------|
| 1 ~ 4 | +2 |
| 5 ~ 8 | +3 |
| 9 ~ 12 | +4 |
| 13 ~ 16 | +5 |
| 17 ~ 20 | +6 |

### 3-3. DC (난이도 등급)

시나리오 난이도에 따라 DC가 결정됩니다:

| 난이도 | DC |
|--------|----|
| 쉬움 (EASY) | 8 |
| 보통 (NORMAL) | 12 |
| 어려움 (HARD) | 15 |
| 악몽 (NIGHTMARE) | 18 |

### 3-4. 판정 유형 (DiceCheckType)

| 유형 | 설명 |
|------|------|
| `COMBAT` | 전투 (공격, 방어) |
| `SKILL` | 기술 (잠금 해제, 함정 해제 등) |
| `SOCIAL` | 사교 (설득, 위협, 협상) |
| `EXPLORATION` | 탐험 (은신, 지각, 등반) |

### 3-5. 데미지 주사위 (레벨별)

| 레벨 | 데미지 주사위 |
|------|--------------|
| 1 ~ 2 | 1d4 |
| 3 ~ 4 | 1d6 |
| 5 ~ 6 | 1d8 |
| 7 ~ 8 | 1d10 |
| 9+ | 1d12 |

- **크리티컬 (roll = 20)**: 데미지 주사위 2배
- **펌블 (roll = 1)**: 1d4 자기 피해 (역효과)

### 3-6. Before-Roll 내러티브 흐름 (프론트엔드 UX)

주사위 판정이 필요한 행동에서는 내러티브가 두 단계로 나뉩니다:

```
서버 응답 수신
    │
    ▼
before_narrative 즉시 표시
    │  (예: "당신은 검을 들어올리며 고블린을 향해 돌진합니다...")
    │
    ▼
[ROLL DICE 버튼] 표시 + 메시지 입력창 비활성화
    │
    ▼
플레이어가 버튼 클릭 → 주사위 애니메이션 재생
    │  (실제 판정 결과는 이미 서버에서 결정됨)
    │
    ▼
애니메이션 완료 → narrative(결과 서술) 표시
    │  (예: "날카로운 검격이 고블린의 방패를 뚫고 치명상을 입혔습니다!")
    │
    ▼
메시지 입력창 활성화 → 다음 행동 입력 가능
```

> **주의**: 주사위의 실제 결과(성공/실패)는 서버에서 결정됩니다. 프론트엔드 애니메이션은 순수한 연출용입니다.

### 3-7. 주사위 결과 표시 예시

```
🎲 1d20+2 = 18 vs DC 12 → 성공!
🎲 1d20+2 = 3  vs DC 12 → 실패
🎲 1d20+2 = 22 vs DC 15 → 크리티컬 성공! 🌟
🎲 1d20+2 = 3  vs DC  8 → 펌블! 💥
```

---

## 4. 일러스트 생성 시스템

AI Saga는 각 AI 내러티브 메시지에 대해 **온디맨드 픽셀 아트 일러스트**를 생성할 수 있습니다. 플레이어가 원하는 장면을 직접 선택하여 시각화할 수 있으며, 추후 크레딧 기반 비즈니스 모델의 기반이 됩니다.

### 4-1. 동작 방식 (현재: 플레이스홀더 이미지)

Google Imagen API의 유료 정책 변경으로 인해 **현재는 임시로 플레이스홀더 이미지를 반환**하도록 구현되어 있습니다. 유료 결제 계정 등록 시 Imagen 3 API로 복구하여 실제 내러티브 기반 픽셀 아트를 생성할 수 있습니다.

```
프론트엔드에서 [GEN_ILLUST] 버튼 클릭
    │
    ▼
POST /api/v1/game/sessions/{session_id}/messages/{message_id}/illustration/
    │
    ▼
플레이스홀더 이미지 URL 반환 (임시)
    │ (유료 계정 전환 시 Imagen 3로 복구 필요)
    │
    ▼
image_url을 GameMessage DB에 저장
    │
    ▼
IllustrationResponse { message_id, image_url } 반환
```

### 4-2. 프론트엔드 UX

- **버튼 표시**: AI(SYSTEM.AI) 메시지의 내러티브 바로 아래에 `[GEN_ILLUST]` 버튼 표시
- **로딩 상태**: 버튼 클릭 시 `GENERATING...` 스피너로 전환
- **이미지 표시**: 생성 완료 후 내러티브 바로 아래 인라인으로 픽셀 아트 이미지 렌더링
- **재사용**: 이미 생성된 이미지가 있는 메시지는 버튼 없이 바로 이미지 표시 (히스토리 로드 시 포함)
- **에러 처리**: 생성 실패 시 오류 메시지 표시 후 버튼 복원

### 4-3. 에러 케이스

| HTTP 상태 | 원인 |
|-----------|------|
| `400` | USER 메시지에 일러스트 생성 시도 또는 기능 비활성화 상태 |
| `403` | 다른 유저의 세션에 접근 |
| `404` | 세션 또는 메시지를 찾을 수 없음 |
| `500` | Imagen API 호출 실패 |

---


## 5. 메타 프로그레션 시스템

AI Saga는 **로그라이크** 메타 프로그레션을 채택합니다. 게임을 플레이하면 유저 레벨이 영구적으로 상승하고, 새 게임을 시작할 때 더 강한 캐릭터로 시작할 수 있습니다.

### 4-1. 두 층의 레벨 시스템

| 레벨 | 범위 | 설명 |
|------|------|------|
| **유저 레벨** (영구) | 계정에 귀속 | 게임 클리어 시 XP 획득, 영구 성장 |
| **캐릭터 레벨** (일시) | 세션 내 | 인게임 경험치로 성장, 세션 종료 시 소멸 |

### 4-2. 유저 XP 및 레벨업

#### XP 획득 (게임 종료 시)

엔딩 유형, 진행 턴 수, 시나리오 난이도에 따라 XP가 결정됩니다:

```
XP = (기본 XP) + (턴당 XP × 턴 수)
   × 난이도 배율
```

| 엔딩 유형 | 기본 XP | 턴당 XP | 난이도 배율 |
|-----------|---------|---------|------------|
| 승리 (VICTORY) | 200 | 10 | HARD/NIGHTMARE: ×1.5 |
| 패배 (DEFEAT) | 50 | 5 | HARD/NIGHTMARE: ×1.5 |
| 중립 (NEUTRAL) | 100 | 7 | HARD/NIGHTMARE: ×1.5 |

**예시 (10턴 플레이)**

| 엔딩 | 난이도 | 계산식 | 획득 XP |
|------|--------|--------|---------|
| 승리 | NORMAL | 200 + (10 × 10) | 300 XP |
| 승리 | HARD | (200 + 100) × 1.5 | 450 XP |
| 패배 | NORMAL | 50 + (10 × 5) | 100 XP |
| 중립 | HARD | (100 + 70) × 1.5 | 255 XP |

#### 유저 레벨업 임계값

```
다음 레벨까지 필요 XP = 현재 유저 레벨 × 300
```

| 유저 레벨 | 레벨업 필요 XP |
|-----------|--------------|
| 1 → 2 | 300 XP |
| 2 → 3 | 600 XP |
| 3 → 4 | 900 XP |
| 5 → 6 | 1500 XP |

### 4-3. 캐릭터 생성 시 유저 레벨 보너스

새 게임을 시작할 때 캐릭터는 유저의 현재 레벨을 상속합니다:

| 유저 레벨 | 캐릭터 시작 레벨 | 시작 HP | 숙련 보너스 |
|-----------|----------------|---------|------------|
| 1 | 1 | 100 HP | +2 |
| 3 | 3 | 120 HP | +2 |
| 5 | 5 | 140 HP | +3 |
| 9 | 9 | 180 HP | +4 |

### 4-4. 인게임 캐릭터 레벨업

게임 도중 경험치를 얻어 캐릭터 레벨이 오를 수 있습니다:

```
캐릭터 레벨업 필요 XP = 현재 캐릭터 레벨 × 100
```

| 레벨 | 레벨업 필요 XP | 레벨업 시 HP 증가 |
|------|--------------|-----------------|
| 1 → 2 | 100 XP | +10 HP (10 × 1) |
| 2 → 3 | 200 XP | +20 HP (10 × 2) |
| 3 → 4 | 300 XP | +30 HP (10 × 3) |

- 레벨업 시 HP는 **최대치로 완전 회복**됩니다
- 한 번에 여러 레벨 동시 상승 가능

---

## 6. 게임 엔딩 시스템

### 6-1. 엔딩 트리거 조건

| 트리거 | 조건 | 엔딩 유형 |
|--------|------|----------|
| **최대 턴 도달** | `turn_count >= max_turns` | AI가 결정 (VICTORY/DEFEAT/NEUTRAL) |
| **캐릭터 사망** | `HP <= 0` | 항상 DEFEAT |

### 6-2. 엔딩 생성 흐름

```
엔딩 트리거 감지
    │
    ▼
최근 메시지 10개 수집 (컨텍스트)
    │
    ▼
LLM에게 엔딩 내러티브 생성 요청
    │  - 지금까지의 플레이어 행동 분석
    │  - 엔딩 유형 판단 (victory / defeat / neutral)
    │  - 감동적인 엔딩 스토리 생성
    │
    ▼
엔딩 유형 파싱
    │  "victory" → VICTORY
    │  "defeat"  → DEFEAT
    │  otherwise → NEUTRAL
    │
    ▼
세션 상태 업데이트
    │  status = COMPLETED
    │  ending_type = 결정된 엔딩
    │  ended_at = 현재 시각
    │
    ▼
XP 계산 및 유저에게 지급
    │  UserProgressionService.calculate_game_xp(ending_type, turn_count, difficulty)
    │
    ▼
GameEndingResponse 반환
    │  - ending_type, narrative
    │  - total_turns, xp_gained
    │  - new_game_level, leveled_up, levels_gained
```

### 6-3. 엔딩 유형별 특징

| 엔딩 | 아이콘 | 조건 | 특징 |
|------|--------|------|------|
| **승리 (VICTORY)** | 🏆 | 목표 달성, 퀘스트 완료 | 최고 XP 보상 |
| **패배 (DEFEAT)** | 💀 | HP 소진 또는 치명적 실패 | 최소 XP (경험치 위로 보상) |
| **중립 (NEUTRAL)** | ⚖️ | 명확한 승패 없이 종료 | 중간 XP 보상 |

---

## 7. 수치 요약표

### 주사위 시스템

| 수치 | 공식 |
|------|------|
| 숙련 보너스 | `(레벨 - 1) // 4 + 2` |
| DC (EASY) | 8 |
| DC (NORMAL) | 12 |
| DC (HARD) | 15 |
| DC (NIGHTMARE) | 18 |
| 크리티컬 조건 | 주사위 = 20 |
| 펌블 조건 | 주사위 = 1 |
| 크리티컬 데미지 | 데미지 주사위 × 2 |
| 펌블 데미지 | 1d4 (자기 피해) |

### 메타 프로그레션

| 수치 | 공식 |
|------|------|
| 시작 HP | `100 + (유저레벨 - 1) × 10` |
| 유저 레벨업 XP | `현재 유저레벨 × 300` |
| 캐릭터 레벨업 XP | `현재 캐릭터레벨 × 100` |
| 캐릭터 레벨업 HP 증가 | `10 × 현재 캐릭터레벨` |
| 승리 XP 기본 | `200 + (턴 × 10)` |
| 패배 XP 기본 | `50 + (턴 × 5)` |
| 중립 XP 기본 | `100 + (턴 × 7)` |
| 고난이도 배율 | `× 1.5 (HARD / NIGHTMARE)` |
